# !/bin/bash
# ----------------------------------------------------------------------
# Ericsson Network IQ to remove the duplicate data from DIM_E_GRAN_TG table script
# ----------------------------------------------------------------------
# Copyright (c) 1999 - 2013 AB LM Ericsson  All rights reserved.
# ----------------------------------------------------------------------

# This script insert the non duplicate entres into DIM_E_GRAN_TG. 
#

if [ ${LOGNAME} != "dcuser"  ] ; then
  echo "This script must be executed as dcuser"
  exit 1
fi

if [ -z "$CONF_DIR" ] ; then
  echo "ERROR: CONF_DIR is not set"
  exit 1
fi

#--------------------------------------------------------------------
#Global variable
#--------------------------------------------------------------------

ENIQ_BIN_DIR=/eniq/sw/bin

. ${CONF_DIR}/niq.rc

_dir_=`/usr/bin/dirname $0`
SCRIPTHOME=`cd $_dir_ 2>/dev/null && pwd || echo $_dir_`

if [ -s $SCRIPTHOME/../../admin/lib/common_functions.lib ]; then
    . $SCRIPTHOME/../../admin/lib/common_functions.lib
else
        echo "Could not find $SCRIPTHOME/../../admin/lib/common_functions.lib"
        exit 63
fi
DWHDBPASSWORD=`inigetpassword DWH -v DCPassword -f ${CONF_DIR}/niq.ini`
DBA_PASSWORD=`inigetpassword DB -v DBAPassword -f ${CONF_DIR}/niq.ini`
DWH_PORT=`inigetpassword DWH -v PortNumber -f ${CONF_DIR}/niq.ini`
DWH_NAME=`inigetpassword DWH -v ServerName -f ${CONF_DIR}/niq.ini`
SYBASE_IQ_PATH=${IQ_DIR}/${SYBASE_OCS}/bin/isql

if [ ! -f ${ENIQ_BIN_DIR}/remove_duplicates_DIM_E_GRAN_TG.bsh ] ; then
        echo "${ENIQ_BIN_DIR}/remove_duplicates_DIM_E_GRAN_TG.bsh does not exist"
        exit 1
fi


#--------------------------------------------------------------------
#Creating Stored procedures. 
#--------------------------------------------------------------------
DWH_CONN_STR_USER_DBA="uid=dc;pwd=${DWHDBPASSWORD};eng=dwhdb;links=tcpip{host=localhost;port=${DWH_PORT};dobroadcast=no;verify=no}"

echo "Executing  remove_duplicates_DIM_E_GRAN_TG script.." 

${SYBASE_IQ_PATH} -Udc -P${DWHDBPASSWORD} -Sdwhdb <<EOISQL
select * into #DIM_E_GRAN_TG_copy from DIM_E_GRAN_TG
go           
print "Taking backup from DIM_E_GRAN_TG to #DIM_E_GRAN_TG_copy"

delete from DIM_E_GRAN_TG 
go       
print "Removing entries DIM_E_GRAN_TG"

Insert into DIM_E_GRAN_TG(OSS_ID,TG_NAME,STN_NAME,BSC,SCGR,TG_TRANS,BTSME,VENDOR,STATUS,CREATED,MODIFIED,MODIFIER)Select OSS_ID,TG_NAME,STN_NAME,BSC,SCGR,TG_TRANS,BTSME,VENDOR,STATUS,max(Created) as CREATED,max(MODIFIED) as MODIFIED,MODIFIER FROM #DIM_E_GRAN_TG_copy where OSS_ID+TG_NAME+BSC IN (select distinct OSS_ID+TG_NAME+BSC from #DIM_E_GRAN_TG_copy) group by OSS_ID,TG_NAME,STN_NAME,BSC,SCGR,TG_TRANS,BTSME,VENDOR,STATUS,MODIFIER
go
print "Inserting data into DIM_E_GRAN_TG"


drop table #DIM_E_GRAN_TG_copy
go
EOISQL
echo "Dropped #DIM_E_GRAN_TG_copy"

